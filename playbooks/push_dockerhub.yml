---
- name: Login to Docker Hub and push image
  hosts: localhost  # or specify your target hosts here if needed

  environment:
    DOCKER_USERNAME: "{{ gudurusanjay }}"
    DOCKER_PASSWORD: "{{ Sanjay@1927 }}"

  tasks:
    - name: TAG IMAGE WITH BUILD ID & LATEST
      shell: |
        cd /opt/docker
        docker build -t {{ JOB_NAME }}:v1.{{ BUILD_ID }} .
        docker tag {{ JOB_NAME }}:v1.{{ BUILD_ID }} SanjayGuduru/{{ JOB_NAME }}:v1.{{ BUILD_ID }}
        docker tag {{ JOB_NAME }}:v1.{{ BUILD_ID }} SanjayGuduru/{{ JOB_NAME }}:latest

    - name: LOGIN DOCKERHUB & PUSH IMAGE ON REGISTRY
      shell: |
        docker login -u $DOCKER_USERNAME -p $DOCKER_PASSWORD
        docker push SanjayGuduru/{{ JOB_NAME }}:v1.{{ BUILD_ID }}
        docker push SanjayGuduru/{{ JOB_NAME }}:latest

    - name: REMOVE OLD IMAGES FROM SERVER
      shell: docker rmi -f $(docker images 'SanjayGuduru/{{ JOB_NAME }}' -a -q) &> /dev/null

    - name: LOGOUT DOCKERHUB
      shell: docker logout

